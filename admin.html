<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <title>商品管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    #jsonOutput {
      width: 100%;
      height: 200px;
    }

    .table td,
    .table th {
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div class="container" x-data="productAdmin()" x-init="loadJson()">
    <h2 class="my-4 text-center">商品管理</h2>
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-outline-primary" @click="addProduct">新增商品</button>
      <button class="btn btn-success" @click="uploadJson">儲存設定</button>
    </div>
    <div id="jsonMsg" x-text="msg" class="mb-2"></div>
    <div id="tableArea">
      <template x-if="products.length">
        <table class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>品名</th>
              <th>單價</th>
              <th>群組</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(item, idx) in products" :key="idx">
              <tr>
                <td><input type="text" class="form-control" x-model="item.product_name" @input="updateJsonPreview">
                </td>
                <td><input type="number" class="form-control" x-model.number="item.price" min="0" step="1"
                    @input="updateJsonPreview"></td>
                <td><input type="number" class="form-control" x-model.number="item.product_group" min="0" step="1"
                    @input="updateJsonPreview"></td>
                <td><button class="btn btn-danger btn-sm" @click="deleteProduct(idx)">刪除</button></td>
              </tr>
            </template>
          </tbody>
        </table>
      </template>
      <template x-if="!products.length">
        <p>尚未載入商品</p>
      </template>
    </div>
    <label class="form-label mt-3">JSON 預覽：</label>
    <textarea id="jsonOutput" class="form-control" readonly x-model="jsonPreview"></textarea>
  </div>
  <script>
    function productAdmin() {
      return {
        products: [],
        msg: '',
        jsonPreview: '',
        async loadJson() {
          this.msg = '';
          try {
            const res = await fetch('/non_pickup.json');
            if (!res.ok) throw new Error('讀取失敗');
            this.products = await res.json();
            this.updateJsonPreview();
          } catch (e) {
            this.msg = e.message;
          }
        },
        addProduct() {
          this.products.push({
            product_name: '新商品',
            price: 0,
            product_group: 0
          });
          this.updateJsonPreview();
        },
        deleteProduct(idx) {
          if (confirm('確定要刪除這個商品嗎？')) {
            this.products.splice(idx, 1);
            this.updateJsonPreview();
          }
        },
        updateJsonPreview() {
          this.jsonPreview = JSON.stringify(this.products, null, 2);
        },
        async uploadJson() {
          this.msg = '';
          try {
            const res = await fetch('/.netlify/functions/updateNonPickup', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.products)
            });
            const result = await res.json();
            if (result.success) {
              this.msg = '上傳成功！';
            } else {
              this.msg = '上傳失敗：' + (result.message || result.error || '未知錯誤');
            }
          } catch (e) {
            this.msg = '上傳失敗：' + e.message;
          }
        }
      };
    }
  </script>
</body>

</html>