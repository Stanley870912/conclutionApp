<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>non_pickup.json 後台管理</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    input[type="number"] { width: 80px; }
    #jsonMsg { color: red; margin-top: 10px; }
    #jsonOutput { width: 100%; height: 200px; }
  </style>
</head>
<body>
  <h2>non_pickup.json 商品管理</h2>
  <button id="loadJsonBtn">讀取商品</button>
  <button id="exportJsonBtn">匯出 JSON</button>
  <button id="uploadJsonBtn">上傳到 GitHub</button>
  <button id="addProductBtn">新增商品</button>
  <div id="jsonMsg"></div>
  <div id="tableArea"></div>
  <textarea id="jsonOutput" readonly></textarea>
  <script>
    let products = [];
    // 讀取 JSON
    document.getElementById('loadJsonBtn').onclick = async function() {
      document.getElementById('jsonMsg').textContent = '';
      try {
        const res = await fetch('/non_pickup.json');
        if (!res.ok) throw new Error('讀取失敗');
        products = await res.json();
        renderTable();
      } catch(e) {
        document.getElementById('jsonMsg').textContent = e.message;
      }
    };
    // 匯出 JSON
    document.getElementById('exportJsonBtn').onclick = function() {
      document.getElementById('jsonOutput').value = JSON.stringify(products, null, 2);
    };
    // 上傳到 GitHub
    document.getElementById('uploadJsonBtn').onclick = async function() {
      document.getElementById('jsonMsg').textContent = '';
      try {
        const res = await fetch('/.netlify/functions/updateNonPickup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(products)
        });
        const result = await res.json();
        if (result.success) {
          document.getElementById('jsonMsg').textContent = '上傳成功！';
        } else {
          document.getElementById('jsonMsg').textContent = '上傳失敗：' + (result.message || '未知錯誤');
        }
      } catch(e) {
        document.getElementById('jsonMsg').textContent = '上傳失敗：' + e.message;
      }
    };
    // 新增商品
    document.getElementById('addProductBtn').onclick = function() {
      products.push({
        product_name: '新商品',
        price: 0,
        product_group: 0
      });
      renderTable();
    };
    // 刪除商品
    window.deleteProduct = function(idx) {
      if (confirm('確定要刪除這個商品嗎？')) {
        products.splice(idx, 1);
        renderTable();
      }
    };
    // 渲染商品表格
    function renderTable() {
      const area = document.getElementById('tableArea');
      if (!products.length) {
        area.innerHTML = '<p>尚未載入商品</p>';
        return;
      }
      let html = '<table><thead><tr>' +
        '<th>品名</th><th>單價</th><th>群組</th><th>操作</th>' +
        '</tr></thead><tbody>';
      products.forEach((item, idx) => {
        html += `<tr>
          <td><input type="text" value="${item.product_name}" onchange="updateName(${idx}, this.value)"></td>
          <td><input type="number" value="${item.price}" min="0" step="1" onchange="updatePrice(${idx}, this.value)"></td>
          <td><input type="number" value="${item.product_group}" min="0" step="1" onchange="updateGroup(${idx}, this.value)"></td>
          <td><button onclick="deleteProduct(${idx})">刪除</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      area.innerHTML = html;
    }
    // 更新品名
    window.updateName = function(idx, val) {
      products[idx].product_name = val;
    };
    // 更新價格
    window.updatePrice = function(idx, val) {
      products[idx].price = Number(val);
    };
    // 更新群組
    window.updateGroup = function(idx, val) {
      products[idx].product_group = Number(val);
    };
  </script>
</body>
</html>
