<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>non_pickup.json 後台管理</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #jsonMsg { color: red; margin-top: 10px; }
    #jsonOutput { width: 100%; height: 200px; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="my-4 text-center">non_pickup.json 商品管理</h2>
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <button id="exportJsonBtn" class="btn btn-secondary">匯出 JSON</button>
      <button id="uploadJsonBtn" class="btn btn-success">上傳到 GitHub</button>
      <button id="addProductBtn" class="btn btn-outline-primary">新增商品</button>
    </div>
    <div id="jsonMsg"></div>
    <div id="tableArea"></div>
    <label class="form-label mt-3">JSON 預覽：</label>
    <textarea id="jsonOutput" class="form-control" readonly></textarea>
  </div>
  <script>
    let products = [];
    // 新增商品
    document.getElementById('addProductBtn').onclick = function() {
      products.push({
        product_name: '新商品',
        price: 0,
        product_group: 0
      });
      renderTable();
    };
    // 刪除商品
    window.deleteProduct = function(idx) {
      if (confirm('確定要刪除這個商品嗎？')) {
        products.splice(idx, 1);
        renderTable();
      }
    };
    // 渲染商品表格
    function renderTable() {
      const area = document.getElementById('tableArea');
      if (!products.length) {
        area.innerHTML = '<p>尚未載入商品</p>';
        return;
      }
      let html = '<table class="table table-bordered table-striped"><thead><tr>' +
        '<th>品名</th><th>單價</th><th>群組</th><th>操作</th>' +
        '</tr></thead><tbody>';
      products.forEach((item, idx) => {
        html += `<tr>
          <td><input type="text" class="form-control" value="${item.product_name}" onchange="updateName(${idx}, this.value)"></td>
          <td><input type="number" class="form-control" value="${item.price}" min="0" step="1" onchange="updatePrice(${idx}, this.value)"></td>
          <td><input type="number" class="form-control" value="${item.product_group}" min="0" step="1" onchange="updateGroup(${idx}, this.value)"></td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteProduct(${idx})">刪除</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      area.innerHTML = html;
    }
    // 更新品名
    window.updateName = function(idx, val) {
      products[idx].product_name = val;
    };
    // 更新價格
    window.updatePrice = function(idx, val) {
      products[idx].price = Number(val);
    };
    // 更新群組
    window.updateGroup = function(idx, val) {
      products[idx].product_group = Number(val);
    };
    // 讀取 JSON（自動執行）
    async function loadJson() {
      document.getElementById('jsonMsg').textContent = '';
      try {
        const res = await fetch('/non_pickup.json');
        if (!res.ok) throw new Error('讀取失敗');
        products = await res.json();
        renderTable();
      } catch(e) {
        document.getElementById('jsonMsg').textContent = e.message;
      }
    }
    // 頁面載入自動讀取
    window.addEventListener('DOMContentLoaded', loadJson);
    // 匯出 JSON
    document.getElementById('exportJsonBtn').onclick = function() {
      document.getElementById('jsonOutput').value = JSON.stringify(products, null, 2);
    };
    // 上傳到 GitHub
    document.getElementById('uploadJsonBtn').onclick = async function() {
      document.getElementById('jsonMsg').textContent = '';
      try {
        const res = await fetch('/.netlify/functions/updateNonPickup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(products)
        });
        const result = await res.json();
        if (result.success) {
          document.getElementById('jsonMsg').textContent = '上傳成功！';
        } else {
          document.getElementById('jsonMsg').textContent = '上傳失敗：' + (result.message || result.error || '未知錯誤');
        }
      } catch(e) {
        document.getElementById('jsonMsg').textContent = '上傳失敗：' + e.message;
      }
    };
  </script>
</body>
</html>
